{"version":3,"sources":["../../src/commands/develop.js"],"names":["program","directory","directoryPath","withBasePath","createIndexHtml","developHtml","catch","err","name","report","panic","stripIndent","bootstrap","webpackConfig","port","compilerConfig","devConfig","resolve","compiler","webpack","app","express","use","require","log","path","heartbeat","graphqlHTTP","schema","store","getState","graphiql","req","res","next","header","post","enableRefresh","process","env","ENABLE_GATSBY_REFRESH_ENDPOINT","refreshToken","GATSBY_REFRESH_TOKEN","authorizedRefresh","headers","authorization","console","sourceNodes","end","get","launchEditor","query","fileName","lineNumber","static","__dirname","noInfo","quiet","publicPath","output","proxy","config","prefix","url","proxiedUrl","originalUrl","pipe","request","sendFile","decodeURIComponent","parsedPath","parsePath","extname","startsWith","status","endsWith","server","Server","ssl","createServer","io","on","socket","join","listener","listen","host","code","watchGlobs","map","chokidar","watch","to","emit","startServer","rl","copyStaticDirectory","formatWebpackMessages","chalk","address","getSslCert","setTimeout","rlInterface","createInterface","input","stdin","stdout","exit","module","exports","prepareUrls","printInstructions","appName","urls","useYarn","bold","lanUrlForTerminal","localUrlForTerminal","cyan","protocol","formatUrl","format","hostname","pathname","prettyPrintUrl","isUnspecifiedHost","lanUrlForConfig","ip","test","undefined","_e","localUrlForBrowser","detect","parseInt","https","sitePackageJson","Promise","_port","question","answer","length","match","then","c","l","isFirstCompile","plugin","messages","stats","toJson","isSuccessful","errors","warnings","open"],"mappings":"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","file":"develop.js","sourcesContent":["/* @flow */\n\nconst url = require(`url`)\nconst chokidar = require(`chokidar`)\nconst express = require(`express`)\nconst graphqlHTTP = require(`express-graphql`)\nconst parsePath = require(`parse-filepath`)\nconst request = require(`request`)\nconst rl = require(`readline`)\nconst webpack = require(`webpack`)\nconst webpackConfig = require(`../utils/webpack.config`)\nconst bootstrap = require(`../bootstrap`)\nconst { store } = require(`../redux`)\nconst copyStaticDirectory = require(`../utils/copy-static-directory`)\nconst developHtml = require(`./develop-html`)\nconst { withBasePath } = require(`../utils/path`)\nconst report = require(`gatsby-cli/lib/reporter`)\nconst launchEditor = require(`react-dev-utils/launchEditor`)\nconst formatWebpackMessages = require(`react-dev-utils/formatWebpackMessages`)\nconst chalk = require(`chalk`)\nconst address = require(`address`)\nconst sourceNodes = require(`../utils/source-nodes`)\nconst getSslCert = require(`../utils/get-ssl-cert`)\n\n// const isInteractive = process.stdout.isTTY\n\n// Watch the static directory and copy files to public as they're added or\n// changed. Wait 10 seconds so copying doesn't interfer with the regular\n// bootstrap.\nsetTimeout(() => {\n  copyStaticDirectory()\n}, 10000)\n\nconst rlInterface = rl.createInterface({\n  input: process.stdin,\n  output: process.stdout,\n})\n\n// Quit immediately on hearing ctrl-c\nrlInterface.on(`SIGINT`, () => {\n  process.exit()\n})\n\nasync function startServer(program) {\n  const directory = program.directory\n  const directoryPath = withBasePath(directory)\n  const createIndexHtml = () =>\n    developHtml(program).catch(err => {\n      if (err.name !== `WebpackError`) {\n        report.panic(err)\n        return\n      }\n      report.panic(\n        report.stripIndent`\n          There was an error compiling the html.js component for the development server.\n\n          See our docs page on debugging HTML builds for help https://goo.gl/yL9lND\n        `,\n        err\n      )\n    })\n\n  // Start bootstrap process.\n  await bootstrap(program)\n\n  await createIndexHtml()\n\n  const compilerConfig = await webpackConfig(\n    program,\n    directory,\n    `develop`,\n    program.port\n  )\n\n  const devConfig = compilerConfig.resolve()\n  const compiler = webpack(devConfig)\n\n  /**\n   * Set up the express app.\n   **/\n  const app = express()\n  app.use(\n    require(`webpack-hot-middleware`)(compiler, {\n      log: () => {},\n      path: `/__webpack_hmr`,\n      heartbeat: 10 * 1000,\n    })\n  )\n  app.use(\n    `/___graphql`,\n    graphqlHTTP({\n      schema: store.getState().schema,\n      graphiql: true,\n    })\n  )\n\n  // Allow requests from any origin. Avoids CORS issues when using the `--host` flag.\n  app.use((req, res, next) => {\n    res.header(`Access-Control-Allow-Origin`, `*`)\n    res.header(\n      `Access-Control-Allow-Headers`,\n      `Origin, X-Requested-With, Content-Type, Accept`\n    )\n    next()\n  })\n\n  /**\n   * Refresh external data sources.\n   * This behavior is disabled by default, but the ENABLE_REFRESH_ENDPOINT env var enables it\n   * If no GATSBY_REFRESH_TOKEN env var is available, then no Authorization header is required\n   **/\n  app.post(`/__refresh`, (req, res) => {\n    const enableRefresh = process.env.ENABLE_GATSBY_REFRESH_ENDPOINT\n    const refreshToken = process.env.GATSBY_REFRESH_TOKEN\n    const authorizedRefresh =\n      !refreshToken || req.headers.authorization === refreshToken\n\n    if (enableRefresh && authorizedRefresh) {\n      console.log(`Refreshing source data`)\n      sourceNodes()\n    }\n    res.end()\n  })\n\n  app.get(`/__open-stack-frame-in-editor`, (req, res) => {\n    launchEditor(req.query.fileName, req.query.lineNumber)\n    res.end()\n  })\n\n  app.use(express.static(__dirname + `/public`))\n\n  app.use(\n    require(`webpack-dev-middleware`)(compiler, {\n      noInfo: true,\n      quiet: true,\n      publicPath: devConfig.output.publicPath,\n    })\n  )\n\n  // Set up API proxy.\n  const { proxy } = store.getState().config\n  if (proxy) {\n    const { prefix, url } = proxy\n    app.use(`${prefix}/*`, (req, res) => {\n      const proxiedUrl = url + req.originalUrl\n      req.pipe(request(proxiedUrl)).pipe(res)\n    })\n  }\n\n  // Check if the file exists in the public folder.\n  app.get(`*`, (req, res, next) => {\n    // Load file but ignore errors.\n    res.sendFile(\n      directoryPath(`/public${decodeURIComponent(req.path)}`),\n      err => {\n        // No err so a file was sent successfully.\n        if (!err || !err.path) {\n          next()\n        } else if (err) {\n          // There was an error. Let's check if the error was because it\n          // couldn't find an HTML file. We ignore these as we want to serve\n          // all HTML from our single empty SSR html file.\n          const parsedPath = parsePath(err.path)\n          if (\n            parsedPath.extname === `` ||\n            parsedPath.extname.startsWith(`.html`)\n          ) {\n            next()\n          } else {\n            res.status(404).end()\n          }\n        }\n      }\n    )\n  })\n\n  // Render an HTML page and serve it.\n  app.use((req, res, next) => {\n    const parsedPath = parsePath(req.path)\n    if (\n      parsedPath.extname === `` ||\n      parsedPath.extname.startsWith(`.html`) ||\n      parsedPath.path.endsWith(`/`)\n    ) {\n      res.sendFile(directoryPath(`public/index.html`), err => {\n        if (err) {\n          res.status(500).end()\n        }\n      })\n    } else {\n      next()\n    }\n  })\n\n  /**\n   * Set up the HTTP server and socket.io.\n   **/\n\n  let server = require(`http`).Server(app)\n\n  // If a SSL cert exists in program, use it with `createServer`.\n  if (program.ssl) {\n    server = require(`https`).createServer(program.ssl, app)\n  }\n\n  const io = require(`socket.io`)(server)\n\n  io.on(`connection`, socket => {\n    socket.join(`clients`)\n  })\n\n  const listener = server.listen(program.port, program.host, err => {\n    if (err) {\n      if (err.code === `EADDRINUSE`) {\n        // eslint-disable-next-line max-len\n        report.panic(\n          `Unable to start Gatsby on port ${\n            program.port\n          } as there's already a process listing on that port.`\n        )\n        return\n      }\n\n      report.panic(`There was a problem starting the development server`, err)\n    }\n  })\n\n  // Register watcher that rebuilds index.html every time html.js changes.\n  const watchGlobs = [`src/html.js`, `plugins/**/gatsby-ssr.js`].map(path =>\n    directoryPath(path)\n  )\n\n  chokidar.watch(watchGlobs).on(`change`, async () => {\n    await createIndexHtml()\n    io.to(`clients`).emit(`reload`)\n  })\n\n  return [compiler, listener]\n}\n\nmodule.exports = async (program: any) => {\n  const detect = require(`detect-port`)\n  const port =\n    typeof program.port === `string` ? parseInt(program.port, 10) : program.port\n\n  // Check if https is enabled, then create or get SSL cert.\n  // Certs are named after `name` inside the project's package.json.\n  if (program.https) {\n    program.ssl = await getSslCert(program.sitePackageJson.name)\n  }\n\n  let compiler\n  await new Promise(resolve => {\n    detect(port, (err, _port) => {\n      if (err) {\n        report.panic(err)\n      }\n\n      if (port !== _port) {\n        // eslint-disable-next-line max-len\n        const question = `Something is already running at port ${port} \\nWould you like to run the app at another port instead? [Y/n] `\n\n        rlInterface.question(question, answer => {\n          if (answer.length === 0 || answer.match(/^yes|y$/i)) {\n            program.port = _port // eslint-disable-line no-param-reassign\n          }\n\n          startServer(program).then(([c, l]) => {\n            compiler = c\n            resolve()\n          })\n        })\n      } else {\n        startServer(program).then(([c, l]) => {\n          compiler = c\n          resolve()\n        })\n      }\n    })\n  })\n\n  function prepareUrls(protocol, host, port) {\n    const formatUrl = hostname =>\n      url.format({\n        protocol,\n        hostname,\n        port,\n        pathname: `/`,\n      })\n    const prettyPrintUrl = hostname =>\n      url.format({\n        protocol,\n        hostname,\n        port: chalk.bold(port),\n        pathname: `/`,\n      })\n\n    const isUnspecifiedHost = host === `0.0.0.0` || host === `::`\n    let lanUrlForConfig, lanUrlForTerminal\n    if (isUnspecifiedHost) {\n      try {\n        // This can only return an IPv4 address\n        lanUrlForConfig = address.ip()\n        if (lanUrlForConfig) {\n          // Check if the address is a private ip\n          // https://en.wikipedia.org/wiki/Private_network#Private_IPv4_address_spaces\n          if (\n            /^10[.]|^172[.](1[6-9]|2[0-9]|3[0-1])[.]|^192[.]168[.]/.test(\n              lanUrlForConfig\n            )\n          ) {\n            // Address is private, format it for later use\n            lanUrlForTerminal = prettyPrintUrl(lanUrlForConfig)\n          } else {\n            // Address is not private, so we will discard it\n            lanUrlForConfig = undefined\n          }\n        }\n      } catch (_e) {\n        // ignored\n      }\n    }\n    // TODO collect errors (GraphQL + Webpack) in Redux so we\n    // can clear terminal and print them out on every compile.\n    // Borrow pretty printing code from webpack plugin.\n    const localUrlForTerminal = prettyPrintUrl(host)\n    const localUrlForBrowser = formatUrl(host)\n    return {\n      lanUrlForConfig,\n      lanUrlForTerminal,\n      localUrlForTerminal,\n      localUrlForBrowser,\n    }\n  }\n\n  function printInstructions(appName, urls, useYarn) {\n    console.log()\n    console.log(`You can now view ${chalk.bold(appName)} in the browser.`)\n    console.log()\n\n    if (urls.lanUrlForTerminal) {\n      console.log(\n        `  ${chalk.bold(`Local:`)}            ${urls.localUrlForTerminal}`\n      )\n      console.log(\n        `  ${chalk.bold(`On Your Network:`)}  ${urls.lanUrlForTerminal}`\n      )\n    } else {\n      console.log(`  ${urls.localUrlForTerminal}`)\n    }\n\n    console.log()\n    console.log(\n      `View GraphiQL, an in-browser IDE, to explore your site's data and schema`\n    )\n    console.log()\n    console.log(`  ${urls.localUrlForTerminal}___graphql`)\n\n    console.log()\n    console.log(`Note that the development build is not optimized.`)\n    console.log(\n      `To create a production build, use ` + `${chalk.cyan(`gatsby build`)}`\n    )\n    console.log()\n  }\n\n  let isFirstCompile = true\n  // \"done\" event fires when Webpack has finished recompiling the bundle.\n  // Whether or not you have warnings or errors, you will get this event.\n  compiler.plugin(`done`, stats => {\n    // We have switched off the default Webpack output in WebpackDevServer\n    // options so we are going to \"massage\" the warnings and errors and present\n    // them in a readable focused way.\n    const messages = formatWebpackMessages(stats.toJson({}, true))\n    const urls = prepareUrls(\n      program.ssl ? `https` : `http`,\n      program.host,\n      program.port\n    )\n    const isSuccessful = !messages.errors.length && !messages.warnings.length\n    // if (isSuccessful) {\n    // console.log(chalk.green(`Compiled successfully!`))\n    // }\n    // if (isSuccessful && (isInteractive || isFirstCompile)) {\n    if (isSuccessful && isFirstCompile) {\n      printInstructions(program.sitePackageJson.name, urls, program.useYarn)\n      if (program.open) {\n        require(`opn`)(urls.localUrlForBrowser)\n      }\n    }\n\n    isFirstCompile = false\n\n    // If errors exist, only show errors.\n    // if (messages.errors.length) {\n    // // Only keep the first error. Others are often indicative\n    // // of the same problem, but confuse the reader with noise.\n    // if (messages.errors.length > 1) {\n    // messages.errors.length = 1\n    // }\n    // console.log(chalk.red(\"Failed to compile.\\n\"))\n    // console.log(messages.errors.join(\"\\n\\n\"))\n    // return\n    // }\n\n    // Show warnings if no errors were found.\n    // if (messages.warnings.length) {\n    // console.log(chalk.yellow(\"Compiled with warnings.\\n\"))\n    // console.log(messages.warnings.join(\"\\n\\n\"))\n\n    // // Teach some ESLint tricks.\n    // console.log(\n    // \"\\nSearch for the \" +\n    // chalk.underline(chalk.yellow(\"keywords\")) +\n    // \" to learn more about each warning.\"\n    // )\n    // console.log(\n    // \"To ignore, add \" +\n    // chalk.cyan(\"// eslint-disable-next-line\") +\n    // \" to the line before.\\n\"\n    // )\n    // }\n  })\n}\n"]}